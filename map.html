<!DOCTYPE html>
<html>
<head>
    <title>Referral Routing - Forensic Mode</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCWYDQ2ruxrrYSKZpwVUkI2uhSRjgb-6uU&libraries=geometry"></script>
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        #routing-panel { background: #f8d7da; padding: 10px; border-bottom: 2px solid #dc3545; color: #721c24; font-size: 12px; }
        #map { height: calc(100vh - 50px); width: 100%; }
        #debug-controls { padding: 10px; background: white; border-bottom: 1px solid #ccc; }
    </style>
</head>
<body>

    <div id="routing-panel">
        <strong>FORENSIC MODE ACTIVE:</strong> Check Console for "FULL RECORD DUMP".
    </div>
    <div id="debug-controls">
        Status: <span id="status">Waiting...</span>
        <button onclick="forceTestAddress()">Force Test Address (Venice, FL)</button>
    </div>

    <div id="map"></div>

    <script>
        const SEARCH_RADIUS_LIMIT = 100; 
        const SERVICE_COLORS = { 'DME': '#FF0000', 'Direct PT': '#4169E1', 'Contracted PT': '#4169E1', 'Physical Therapy': '#4169E1', 'Home Health': '#00AA00', 'Diagnostic Imaging': '#FFD700', 'Field Nurse CM': '#800080' };

        let map, patientLocation, currentReferral = {}, geocoder, bounds;

        // 1. LISTEN
        ZOHO.embeddedApp.on("PageLoad", function(data){
            if(data && data.EntityId) loadReferralData(data.EntityId);
        });

        // 2. INIT
        ZOHO.embeddedApp.init().then(function(){
            document.getElementById('status').innerText = "Zoho Connected. Loading Data...";
        });

        async function loadReferralData(recordId) {
            try {
                const response = await ZOHO.CRM.API.getRecord({Entity: "Referrals", RecordID: recordId});
                if(response.data && response.data.length > 0){
                    currentReferral = response.data[0];
                    
                    // *** THE SMOKING GUN: PRINT EVERYTHING ***
                    console.log("%c [DIAGNOSTIC] FULL RECORD DUMP: ", "background: #222; color: #bada55", currentReferral);
                    
                    initMap();
                }
            } catch (e) {
                console.error(e);
                document.getElementById('status').innerText = "Error: " + e.message;
            }
        }

        function initMap() {
            geocoder = new google.maps.Geocoder();
            bounds = new google.maps.LatLngBounds();
            map = new google.maps.Map(document.getElementById('map'), { center: { lat: 27.099, lng: -82.454 }, zoom: 4 });
            plotPatientLocation();
        }

        function plotPatientLocation() {
            // PULLING FIELDS - CHECK THESE AGAINST CONSOLE DUMP
            // Using the NEW text field you created:
            let rawStreet = currentReferral.Claimant_Address_Street_1;
            let rawCity = currentReferral.Claimant_Address_City;
            let rawState = currentReferral.Claimant_State; // <--- VERIFY THIS NAME IN CONSOLE
            let rawZip = currentReferral.Claimant_Address_Zip;

            console.log("EXTRACTED VALUES:", { rawStreet, rawCity, rawState, rawZip });

            // Construct
            const fullAddress = `${rawStreet || ''}, ${rawCity || ''}, ${rawState || ''} ${rawZip || ''}`;
            
            if (fullAddress.length < 8 || !rawStreet) {
                console.error("Address invalid: " + fullAddress);
                document.getElementById('status').innerText = "Address Invalid: '" + fullAddress + "'";
                return;
            }

            geocodeAndPlot(fullAddress);
        }

        function geocodeAndPlot(address) {
            document.getElementById('status').innerText = "Geocoding: " + address;
            geocoder.geocode({ 'address': address }, function(results, status) {
                if (status === 'OK') {
                    patientLocation = results[0].geometry.location;
                    new google.maps.Marker({ map: map, position: patientLocation, title: "Claimant" });
                    map.setCenter(patientLocation);
                    map.setZoom(10);
                    document.getElementById('status').innerText = "Located: " + address;
                    
                    // Now fetch providers
                    fetchAllProviders();
                } else {
                    console.error("Geocode Failed: " + status);
                    document.getElementById('status').innerText = "Google Rejected: " + status;
                }
            });
        }

        // DEBUG BUTTON
        window.forceTestAddress = function() {
            geocodeAndPlot("606 Vistera Blvd, Venice, FL 34275");
        }

        async function fetchAllProviders() {
             // ... (Standard fetch logic we verified works) ...
             // Minimized for diagnostic clarity
             document.getElementById('status').innerText += " | Fetching Providers...";
             let response = await ZOHO.CRM.API.getAllRecords({ Entity: "Sole_Clinicians", sort_order: "asc", per_page: 200 });
             if(response.data) processProviders(response.data);
        }

        function processProviders(providers) {
            // Simple plot
            providers.forEach(p => {
                if(p.Provider_Latitude && p.Provider_Longitude) {
                    let pos = { lat: parseFloat(p.Provider_Latitude), lng: parseFloat(p.Provider_Longitude) };
                    new google.maps.Marker({ map: map, position: pos, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 5, fillColor: 'red', fillOpacity: 0.8, strokeColor: 'white', strokeWeight: 1 } });
                    bounds.extend(pos);
                }
            });
            if(!bounds.isEmpty()) map.fitBounds(bounds);
        }
    </script>
</body>
</html>
